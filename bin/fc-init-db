#!/usr/bin/env ruby

require 'optparse'
require 'filecluster'

descriptions = {
  :host =>     {:short => 'h', :full => 'host',     :default => 'localhost', :text => 'mysql host name, default "localhost"'},
  :database => {:short => 'd', :full => 'db',       :default => 'fc',        :text => 'mysql database, default "fc"'},
  :username => {:short => 'u', :full => 'user',     :default => 'root',      :text => 'mysql user, default "root"'},
  :password => {:short => 'p', :full => 'password', :default => '',          :text => 'mysql password, default ""'},
  :port =>     {:short => 'P', :full => 'port',     :default => '3306',      :text => 'mysql port, default "3306"'},
  :prefix =>   {:short => 't', :full => 'prefix',   :default => '',          :text => 'tables prefix, default ""'}
}

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: fc-init-db [options]\nInitialize FileCluster database."
  opts.separator "Options:"
  
  descriptions.each_entry do |key, desc|
    options[key] = desc[:default]
    opts.on("-#{desc[:short]}}", "--#{desc[:full]}=#{desc[:full].upcase}", desc[:text]) {|s| options[key] = s }
  end
  opts.on_tail("-?", "--help", "Show this message") do
    puts opts
    exit
  end
end.parse!

puts options.inspect.gsub(/[\{\}\:]/, "").gsub(", ", "\n").gsub(/(.{7,})=>/, "\\1:\t").gsub("=>", ":\t\t")
print "Continue? "
s = STDIN.gets.strip.downcase
if s == "y" || s == "yes"
  FC::DB.connect_by_config(options)
  FC::DB.init_db
  puts "Finished."
end
